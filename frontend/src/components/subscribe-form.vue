<template>
    <form class="newsletter" @submit.prevent="subscribeNewsletter">
        <h2 class="sc">
            {{ t("beta-test-title") }}
        </h2>
        <p>
            {{ t("beta-test-text") }}
        </p>
        <div class="newsletter-form">
            <label>
                <span class="checkmark-text">{{ t("newsletter-subscription-checkbox") }}</span>
                <input type="checkbox" v-model="newsletter" :disabled="isLoading">
            </label>
            <div class="newsletter-input-and-button">
                <input class="input-field" type="email" v-model="email" placeholder="Enter your email" required :disabled="isLoading">
                <button type="submit" :disabled="isLoading">
                    <span v-if="isLoading">âŒ›</span>
                    <span v-else>Join</span>
                </button>
            </div>
            <p :class="messageColor">{{ message }}</p>
        </div>
    </form>
</template>

<script setup lang="ts">
    import httpService from '@/services/http.service';
    import { AxiosError } from 'axios';
    import { ref, Ref, computed } from 'vue';
    import { useI18n } from 'vue-i18n';
    
    const { t } = useI18n();
    
    const email = ref('');
    const message = ref('');
    const messageType: Ref<"green" | "red"> = ref('green');
    const isLoading = ref(false);
    const newsletter = ref(true);

    const messageColor = computed(() => {
        return {
            active: true,
            "green": messageType.value === "green",
            "red": messageType.value === "red",
        }
    });

    const subscribeNewsletter = async () => {
        isLoading.value = true;
        try {
            const body = {
                email: email.value,
                language: navigator.language.startsWith("fr") ? "french" : "english",
                newsletter: newsletter.value
            }
            const { data } = await httpService.request("POST", "subscribe/", body);
            messageType.value = "green";
            message.value = `Welcome, ${data.email}! You have successfully subscribed.`;
        } catch (e: AxiosError | unknown) {
            if (e instanceof AxiosError && e.response?.data.message) {
                message.value = e.response.data.message;
            } else {
                message.value = "Unknown error happened"
            }
            messageType.value = "red";
        } finally {
            isLoading.value = false;
        }
    };
</script>

<style scoped>

    .newsletter {
        width: 100%;
        margin: auto;
        gap: 20px;
    }

    .newsletter h2 {
        margin-top: 0;
    }

    .newsletter-form {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .newsletter-form p {
        margin: 0;
        height: 20px;
    }

    .newsletter-input-and-button {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .newsletter-input-and-button input {
        font-family: "SugoPro";
        flex: 1 0 auto;
        padding: 10px;
        width: 300px;
        font-size: 16px;
        outline: none;
    }

    .newsletter button {
        font-family: "SugoPro";
        color: #fff;
        background-color: #007bff;
        border: none;
        cursor: pointer;
        outline: none;
        padding: 10px 20px;
        font-size: 20px;
        transition: background-color 0.2s ease;
    }

    .newsletter button:hover {
        background-color: #0056b3;
    }

    .green {
        color: green;
    }

    .red {
        color: red;
    }


</style>